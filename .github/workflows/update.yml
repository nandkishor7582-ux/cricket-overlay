name: ğŸ Cricket Auto-Update

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      match_url:
        description: 'Paste match URL here for manual run'
        required: false
        type: string

permissions:
  contents: write

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 4

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Dependencies
        run: npm install --no-package-lock

      - name: âš™ï¸ Apply Manual URL Override
        if: github.event.inputs.match_url != ''
        run: node -e "var fs=require('fs');var cfg=JSON.parse(fs.readFileSync('match-config.json','utf8'));cfg.matchUrl='${{ github.event.inputs.match_url }}';cfg.enabled=true;cfg.lastSet=new Date().toISOString();fs.writeFileSync('match-config.json',JSON.stringify(cfg,null,2));console.log('URL set to:',cfg.matchUrl);"

      - name: ğŸ” Check Config
        id: check_config
        run: |
          node check-config.js || echo "SKIP=true" >> $GITHUB_OUTPUT

      - name: ğŸ•·ï¸ Scrape Live Data
        if: steps.check_config.outputs.SKIP != 'true'
        run: node scraper.js
        timeout-minutes: 3

      - name: ğŸ’¾ Commit data.json
        if: steps.check_config.outputs.SKIP != 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "ğŸ Cricket Bot"
          git add data.json match-config.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ Live update"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
